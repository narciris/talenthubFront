name: Deploy Front Angular

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Verificar existencia de secretos
      - name: Debug Secrets (solo existencia, no valores)
        run: |
          echo "‚úÖ Verificando que existan secrets..."
          echo "SERVER_HOST: ${{ secrets.SERVER_HOST && '‚úÖ OK' || '‚ùå FALTA' }}"
          echo "SERVER_USERNAME: ${{ secrets.SERVER_USERNAME && '‚úÖ OK' || '‚ùå FALTA' }}"
          echo "SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY && '‚úÖ OK' || '‚ùå FALTA' }}"

      # 3Ô∏è‚É£ Crear archivo de clave SSH temporal
      - name: Crear archivo de clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/temp_key
          chmod 600 ~/.ssh/temp_key
          echo "‚úÖ Clave SSH creada, primeras 5 l√≠neas:"
          head -n 5 ~/.ssh/temp_key

      # 4Ô∏è‚É£ Probar conexi√≥n SSH manualmente
      - name: Test SSH Connection
        run: |
          echo "üîπ Probando conexi√≥n SSH..."
          ssh -i ~/.ssh/temp_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "echo '‚úÖ SSH OK'"

      # 5Ô∏è‚É£ Configurar Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 6Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: npm install

      # 7Ô∏è‚É£ Construir Angular App
      - name: Build Angular App
        run: npm run build --if-present

      # 8Ô∏è‚É£ Deploy usando SSH
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          debug: true
          script: |
            echo "‚úÖ Conexi√≥n SSH exitosa"
            rm -rf /var/www/talenthub/talentFront/dist/browser/*
            echo "‚úÖ Carpeta remota limpiada"
